/*
 * Ransomware Detection Rules
 * These rules focus on detecting common ransomware behaviors and indicators
 */

rule Ransomware_File_Operations {
    meta:
        description = "Detects common ransomware file operations"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // File enumeration functions 
        $file_enum1 = "FindFirstFile" ascii wide
        $file_enum2 = "FindNextFile" ascii wide
        $file_enum3 = "ReadDirectoryChanges" ascii wide
        $file_enum4 = "NtQueryDirectoryFile" ascii wide
        $file_enum5 = "directory.GetFiles" ascii wide
        $file_enum6 = "Directory.EnumerateFiles" ascii wide
        $file_enum7 = "listdir" ascii wide
        $file_enum8 = "scandir" ascii wide
        
        // File read/write operations
        $file_op1 = "CreateFile" ascii wide
        $file_op2 = "WriteFile" ascii wide
        $file_op3 = "ReadFile" ascii wide
        $file_op4 = "fwrite" ascii wide
        $file_op5 = "fread" ascii wide
        $file_op6 = "CopyFile" ascii wide
        $file_op7 = "DeleteFile" ascii wide
        $file_op8 = "MoveFile" ascii wide
        
        // Common target file extensions (in regex format)
        $target_ext = /\.(doc|docx|xls|xlsx|ppt|pptx|pdf|jpg|jpeg|png|txt|zip|rar|7z|sql|mdb|accdb|psd|svg|mp3|mp4|dwg|odt|ods|odp|odm|odc|odb|csv|rtf|123|wks|wk1|wk3|wk4|wq1|wq2|wb1|wb2|wb3|dif|slk|bak|bkp|tax|key|pfx|pem|p12|csr|gpg|asc)$/ nocase
        
        // File content operations
        $content_op1 = "CryptEncrypt" ascii wide
        $content_op2 = "CryptDecrypt" ascii wide
        $content_op3 = "RtlEncryptMemory" ascii wide
        $content_op4 = "RtlDecryptMemory" ascii wide
        $content_op5 = "Crypt" ascii wide
        $content_op6 = "AES_set_encrypt_key" ascii wide
        $content_op7 = "EVP_EncryptInit" ascii wide
        $content_op8 = "EVP_DecryptInit" ascii wide
        
        // Suspicious strings
        $ransom1 = "ransom" nocase ascii wide
        $ransom2 = "bitcoin" nocase ascii wide
        $ransom3 = "btc" nocase fullword ascii wide
        $ransom4 = "encrypt" nocase ascii wide
        $ransom5 = "decrypt" nocase ascii wide
        $ransom6 = "payment" nocase ascii wide
        $ransom7 = "files are locked" nocase ascii wide
        $ransom8 = "files are encrypted" nocase ascii wide

    condition:
        (
            (3 of ($file_enum*) and 3 of ($file_op*) and 1 of ($content_op*)) or
            (2 of ($file_enum*) and 2 of ($file_op*) and 1 of ($ransom*) and $target_ext) or
            (2 of ($file_enum*) and 2 of ($file_op*) and 2 of ($content_op*)) or
            (2 of ($ransom*) and 2 of ($file_op*) and 1 of ($content_op*))
        )
}

rule Ransomware_Cryptographic_Operations {
    meta:
        description = "Detects cryptographic operations commonly used in ransomware"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // Cryptographic libraries and imports
        $crypto_lib1 = "Crypto" nocase ascii wide
        $crypto_lib2 = "OpenSSL" nocase ascii wide
        $crypto_lib3 = "bcrypt" nocase ascii wide
        $crypto_lib4 = "cryptdll.dll" nocase ascii wide
        $crypto_lib5 = "libcrypto" nocase ascii wide
        $crypto_lib6 = "cryptopp" nocase ascii wide
        $crypto_lib7 = "cryptlib" nocase ascii wide
        
        // Crypto functions
        $crypto_func1 = "AES_set_encrypt_key" ascii wide
        $crypto_func2 = "AES_encrypt" ascii wide
        $crypto_func3 = "RSA_public_encrypt" ascii wide
        $crypto_func4 = "RSA_private_decrypt" ascii wide
        $crypto_func5 = "EVP_EncryptInit" ascii wide
        $crypto_func6 = "EVP_EncryptUpdate" ascii wide
        $crypto_func7 = "EVP_EncryptFinal" ascii wide
        $crypto_func8 = "EVP_DecryptInit" ascii wide
        $crypto_func9 = "EVP_DecryptUpdate" ascii wide
        $crypto_func10 = "EVP_DecryptFinal" ascii wide
        $crypto_func11 = "CryptEncrypt" ascii wide
        $crypto_func12 = "CryptDecrypt" ascii wide
        $crypto_func13 = "CryptDeriveKey" ascii wide
        $crypto_func14 = "CryptGenKey" ascii wide
        $crypto_func15 = "CryptAcquireContext" ascii wide
        
        // Crypto operations
        $crypto_op1 = "cbc" nocase ascii wide
        $crypto_op2 = "ecb" nocase ascii wide
        $crypto_op3 = "ctr" nocase ascii wide
        $crypto_op4 = "rsa" nocase ascii wide
        $crypto_op5 = "aes" nocase ascii wide
        $crypto_op6 = "rc4" nocase ascii wide
        $crypto_op7 = "3des" nocase ascii wide
        $crypto_op8 = "blowfish" nocase ascii wide
        $crypto_op9 = "CALG_AES" nocase ascii wide
        $crypto_op10 = "CALG_RC4" nocase ascii wide
        
        // Key operations
        $key_op1 = "public key" nocase ascii wide
        $key_op2 = "private key" nocase ascii wide
        $key_op3 = "encrypt key" nocase ascii wide
        $key_op4 = "decrypt key" nocase ascii wide
        $key_op5 = "key exchange" nocase ascii wide
        $key_op6 = "key generation" nocase ascii wide
        $key_op7 = "PKCS" nocase ascii wide

    condition:
        (
            (2 of ($crypto_lib*) and 3 of ($crypto_func*)) or
            (1 of ($crypto_lib*) and 3 of ($crypto_func*) and 2 of ($crypto_op*)) or
            (4 of ($crypto_func*) and 2 of ($key_op*)) or
            (3 of ($crypto_func*) and 3 of ($crypto_op*))
        )
}

rule Ransomware_Notification_Patterns {
    meta:
        description = "Detects ransomware notification messages and patterns"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // Ransom notes filenames
        $note_name1 = "readme.txt" nocase ascii wide
        $note_name2 = "help.txt" nocase ascii wide
        $note_name3 = "help_decrypt" nocase ascii wide
        $note_name4 = "how_to_decrypt" nocase ascii wide
        $note_name5 = "how_to_recover" nocase ascii wide
        $note_name6 = "recover_files" nocase ascii wide
        $note_name7 = "recover_file" nocase ascii wide
        $note_name8 = "recovery_file" nocase ascii wide
        $note_name9 = "recovery_key" nocase ascii wide
        $note_name10 = "decrypt_instruction" nocase ascii wide
        $note_name11 = "ransom.txt" nocase ascii wide
        $note_name12 = "DECRYPT_INSTRUCTION" nocase ascii wide
        $note_name13 = "_readme" nocase ascii wide
        
        // Common message contents
        $msg1 = "your files have been encrypted" nocase ascii wide
        $msg2 = "your files are locked" nocase ascii wide
        $msg3 = "your files are now encrypted" nocase ascii wide
        $msg4 = "pay the ransom" nocase ascii wide
        $msg5 = "bitcoin address" nocase ascii wide
        $msg6 = "btc address" nocase ascii wide
        $msg7 = "wallet address" nocase ascii wide
        $msg8 = "send us email" nocase ascii wide
        $msg9 = "contact us" nocase ascii wide
        $msg10 = "decrypt your files" nocase ascii wide
        $msg11 = "recover your files" nocase ascii wide
        $msg12 = "files will be lost" nocase ascii wide
        $msg13 = "payment deadline" nocase ascii wide
        $msg14 = "within 24 hours" nocase ascii wide
        $msg15 = "within 48 hours" nocase ascii wide
        $msg16 = "within 72 hours" nocase ascii wide
        $msg17 = "tor browser" nocase ascii wide
        $msg18 = ".onion" nocase ascii wide
        
        // File extensions
        $ext1 = ".crypt" nocase ascii wide
        $ext2 = ".crypto" nocase ascii wide
        $ext3 = ".encrypted" nocase ascii wide
        $ext4 = ".locked" nocase ascii wide
        $ext5 = ".enc" nocase ascii wide
        $ext6 = ".crypted" nocase ascii wide
        $ext7 = ".cerber" nocase ascii wide
        $ext8 = ".cerber2" nocase ascii wide
        $ext9 = ".cerber3" nocase ascii wide
        $ext10 = ".crypt" nocase ascii wide
        $ext11 = ".crinf" nocase ascii wide
        $ext12 = ".r5a" nocase ascii wide
        $ext13 = ".ACCDFISA" nocase ascii wide
        $ext14 = ".keybtc@inbox_com" nocase ascii wide
        $ext15 = ".wcry" nocase ascii wide
        $ext16 = ".wncry" nocase ascii wide
        $ext17 = ".wncryt" nocase ascii wide
        $ext18 = ".wnry" nocase ascii wide
        
        // Contact information formats
        $contact1 = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/ ascii wide
        $contact2 = /[a-zA-Z0-9._%+-]+@protonmail\.com/ ascii wide
        $contact3 = /[a-zA-Z0-9._%+-]+@tutanota\.com/ ascii wide
        $contact4 = /[a-zA-Z0-9._%+-]+@onionmail\.org/ ascii wide
        $contact5 = /[a-zA-Z0-9._%+-]+@cock\.li/ ascii wide
        $contact6 = "tox:" nocase ascii wide
        $contact7 = "http://tor" nocase ascii wide
        $contact8 = "https://tor" nocase ascii wide
        $contact9 = "t.me/" nocase ascii wide
        $contact10 = "telegram:" nocase ascii wide
        $contact11 = ".onion/" nocase ascii wide

    condition:
        (
            (1 of ($note_name*) and 2 of ($msg*)) or
            (2 of ($msg*) and 1 of ($ext*)) or
            (1 of ($note_name*) and 1 of ($contact*)) or
            (2 of ($ext*) and 1 of ($msg*)) or
            (1 of ($note_name*) and 1 of ($ext*) and 1 of ($contact*))
        )
}

rule Ransomware_System_Sabotage {
    meta:
        description = "Detects ransomware system sabotage techniques"
        author = "Security Team"
        severity = "critical"
        date = "2023-10-15"
    
    strings:
        // Shadow copy deletion
        $shadow1 = "vssadmin delete shadows" nocase ascii wide
        $shadow2 = "wmic shadowcopy delete" nocase ascii wide
        $shadow3 = "vssadmin resize shadowstorage" nocase ascii wide
        $shadow4 = "wbadmin delete catalog" nocase ascii wide
        $shadow5 = "wbadmin delete systemstatebackup" nocase ascii wide
        $shadow6 = "wbadmin delete backup" nocase ascii wide
        $shadow7 = "diskshadow" nocase ascii wide
        
        // Backup prevention
        $backup1 = "bcdedit /set {default} recoveryenabled No" nocase ascii wide
        $backup2 = "bcdedit /set {default} bootstatuspolicy ignoreallfailures" nocase ascii wide
        $backup3 = "wbadmin delete systemstatebackup" nocase ascii wide
        $backup4 = "wbadmin delete backup" nocase ascii wide
        
        // Recovery prevention
        $recovery1 = "reagentc /disable" nocase ascii wide
        $recovery2 = "bcdedit /set {default} recoveryenabled no" nocase ascii wide
        $recovery3 = "bcdedit /set {default} bootstatuspolicy ignoreallfailures" nocase ascii wide
        
        // System modification
        $system1 = "reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii wide
        $system2 = "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii wide
        $system3 = "reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase ascii wide
        $system4 = "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase ascii wide
        $system5 = "bootcfg /raw" nocase ascii wide
        $system6 = "icacls" nocase ascii wide
        $system7 = "cacls" nocase ascii wide
        $system8 = "taskkill" nocase ascii wide
        
        // Service manipulation
        $service1 = "sc stop" nocase ascii wide
        $service2 = "sc config" nocase ascii wide
        $service3 = "net stop" nocase ascii wide
        $service4 = "taskkill /f /im" nocase ascii wide
        
        // Common targeted services
        $target_svc1 = "sql" nocase ascii wide
        $target_svc2 = "vss" nocase ascii wide
        $target_svc3 = "sharepoint" nocase ascii wide
        $target_svc4 = "msexchange" nocase ascii wide
        $target_svc5 = "sophos" nocase ascii wide
        $target_svc6 = "backup" nocase ascii wide
        $target_svc7 = "av" nocase ascii wide
        $target_svc8 = "antivirus" nocase ascii wide
        $target_svc9 = "defender" nocase ascii wide
        $target_svc10 = "mcafee" nocase ascii wide
        $target_svc11 = "norton" nocase ascii wide
        $target_svc12 = "kaspersky" nocase ascii wide

    condition:
        (
            (1 of ($shadow*)) or
            (1 of ($backup*)) or
            (1 of ($recovery*)) or
            (1 of ($system*) and 1 of ($target_svc*)) or
            (1 of ($service*) and 1 of ($target_svc*))
        )
} 