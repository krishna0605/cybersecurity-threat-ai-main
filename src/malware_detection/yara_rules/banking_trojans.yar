/*
 * Banking Trojan Detection Rules
 * These rules focus on detecting banking trojans and credential stealers
 */

rule Banking_Trojan_Web_Injection {
    meta:
        description = "Detects web injection techniques used by banking trojans"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // HTML/DOM manipulation
        $webinject1 = "document.getElementById" ascii wide
        $webinject2 = "document.getElementsByTagName" ascii wide
        $webinject3 = "document.getElementsByClassName" ascii wide
        $webinject4 = "document.querySelector" ascii wide
        $webinject5 = "document.querySelectorAll" ascii wide
        $webinject6 = "document.forms" ascii wide
        $webinject7 = "MutationObserver" ascii wide
        $webinject8 = "DOMContentLoaded" ascii wide
        $webinject9 = "addEventListener" ascii wide
        $webinject10 = "appendChild" ascii wide
        $webinject11 = "insertBefore" ascii wide
        $webinject12 = "replaceChild" ascii wide
        $webinject13 = "innerHTML" ascii wide
        
        // Form manipulation
        $form1 = "form.submit" ascii wide
        $form2 = "form.action" ascii wide
        $form3 = "input.value" ascii wide
        $form4 = "input.type" ascii wide
        $form5 = "onsubmit" ascii wide
        $form6 = "onchange" ascii wide
        $form7 = "onfocus" ascii wide
        $form8 = "onblur" ascii wide
        $form9 = "keylogger" nocase ascii wide
        $form10 = "keylogging" nocase ascii wide
        
        // Suspicious banking keywords
        $bank1 = "banking" nocase ascii wide
        $bank2 = "login" nocase ascii wide
        $bank3 = "username" nocase ascii wide
        $bank4 = "password" nocase ascii wide
        $bank5 = "account" nocase ascii wide
        $bank6 = "balance" nocase ascii wide
        $bank7 = "transaction" nocase ascii wide
        $bank8 = "transfer" nocase ascii wide
        $bank9 = "credential" nocase ascii wide
        $bank10 = "authentication" nocase ascii wide
        $bank11 = "ssl" nocase ascii wide
        $bank12 = "https" nocase ascii wide
        $bank13 = "certificate" nocase ascii wide
        $bank14 = "router" nocase ascii wide
        $bank15 = "proxy" nocase ascii wide
        
        // Common banking domains or paths
        $domain1 = "bank" nocase ascii wide
        $domain2 = "secure" nocase ascii wide
        $domain3 = "login" nocase ascii wide
        $domain4 = "account" nocase ascii wide
        $domain5 = "banking" nocase ascii wide
        $domain6 = "transfer" nocase ascii wide
        $domain7 = "payment" nocase ascii wide
        $domain8 = "verify" nocase ascii wide
        $domain9 = "auth" nocase ascii wide
        $domain10 = ".com/login" nocase ascii wide
        $domain11 = ".com/account" nocase ascii wide
        $domain12 = "/banking" nocase ascii wide
        $domain13 = "/auth" nocase ascii wide
        $domain14 = "/transfer" nocase ascii wide
        $domain15 = "/payment" nocase ascii wide

    condition:
        (
            (3 of ($webinject*) and 2 of ($form*) and 2 of ($bank*)) or
            (2 of ($webinject*) and 2 of ($form*) and 2 of ($domain*)) or
            (4 of ($webinject*) and 3 of ($bank*) and 1 of ($domain*)) or
            (3 of ($form*) and 3 of ($bank*) and 2 of ($domain*))
        )
}

rule Banking_Trojan_Credential_Theft {
    meta:
        description = "Detects credential theft techniques used by banking trojans"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // Browser credential targets
        $browser1 = "Chrome" nocase ascii wide
        $browser2 = "Firefox" nocase ascii wide
        $browser3 = "Edge" nocase ascii wide
        $browser4 = "Safari" nocase ascii wide
        $browser5 = "Opera" nocase ascii wide
        $browser6 = "Internet Explorer" nocase ascii wide
        $browser7 = "Brave" nocase ascii wide
        $browser8 = "Vivaldi" nocase ascii wide
        
        // Browser credential storage locations and formats
        $storage1 = "Login Data" ascii wide
        $storage2 = "Cookies" ascii wide
        $storage3 = "Web Data" ascii wide
        $storage4 = "logins.json" ascii wide
        $storage5 = "cookies.sqlite" ascii wide
        $storage6 = "formhistory.sqlite" ascii wide
        $storage7 = "signons.sqlite" ascii wide
        $storage8 = "key3.db" ascii wide
        $storage9 = "key4.db" ascii wide
        $storage10 = "places.sqlite" ascii wide
        
        // File system operations
        $fs1 = "AppData\\Local\\Google\\Chrome" nocase ascii wide
        $fs2 = "AppData\\Roaming\\Mozilla\\Firefox" nocase ascii wide
        $fs3 = "AppData\\Local\\Microsoft\\Edge" nocase ascii wide
        $fs4 = "Library/Application Support/Google/Chrome" nocase ascii wide
        $fs5 = "Library/Application Support/Firefox" nocase ascii wide
        $fs6 = ".mozilla/firefox" nocase ascii wide
        $fs7 = ".config/google-chrome" nocase ascii wide
        $fs8 = ".config/chromium" nocase ascii wide
        
        // Decryption functions and APIs
        $decrypt1 = "CryptUnprotectData" ascii wide
        $decrypt2 = "CRYPTPROTECT_UI_FORBIDDEN" ascii wide
        $decrypt3 = "DPAPI" nocase ascii wide
        $decrypt4 = "DATA_BLOB" ascii wide
        $decrypt5 = "NCryptUnprotectSecret" ascii wide
        $decrypt6 = "LsaRetrievePrivateData" ascii wide
        $decrypt7 = "NSS_Init" ascii wide
        $decrypt8 = "PK11_GetInternalKeySlot" ascii wide
        $decrypt9 = "PK11SDR_Decrypt" ascii wide
        
        // SQLite operations
        $sqlite1 = "sqlite" nocase ascii wide
        $sqlite2 = "SELECT * FROM" nocase ascii wide
        $sqlite3 = "SELECT url, username_value, password_value FROM" nocase ascii wide
        $sqlite4 = "SELECT origin_url, username_value, password_value FROM" nocase ascii wide
        $sqlite5 = "SELECT * FROM logins" nocase ascii wide
        $sqlite6 = "SELECT * FROM moz_logins" nocase ascii wide
        $sqlite7 = "SELECT * FROM cookies" nocase ascii wide
        $sqlite8 = "SELECT * FROM moz_cookies" nocase ascii wide
        $sqlite9 = "PRAGMA key" nocase ascii wide

    condition:
        (
            (2 of ($browser*) and 2 of ($storage*) and 1 of ($fs*)) or
            (1 of ($browser*) and 1 of ($storage*) and 1 of ($fs*) and 1 of ($decrypt*)) or
            (1 of ($browser*) and 1 of ($sqlite*) and 1 of ($decrypt*)) or
            (1 of ($fs*) and 2 of ($sqlite*) and 1 of ($decrypt*))
        )
}

rule Banking_Trojan_Network_Activity {
    meta:
        description = "Detects suspicious network activity related to banking trojans"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // Network connectivity checks
        $netcheck1 = "ping" nocase ascii wide
        $netcheck2 = "traceroute" nocase ascii wide
        $netcheck3 = "tracert" nocase ascii wide
        $netcheck4 = "nslookup" nocase ascii wide
        $netcheck5 = "dig" nocase fullword ascii wide
        $netcheck6 = "InternetCheckConnection" ascii wide
        $netcheck7 = "CheckNetIsolation" ascii wide
        $netcheck8 = "IsNetworkAlive" ascii wide
        
        // Network communication functions
        $netfunc1 = "connect" nocase ascii wide
        $netfunc2 = "send" nocase ascii wide
        $netfunc3 = "recv" nocase ascii wide
        $netfunc4 = "socket" nocase ascii wide
        $netfunc5 = "WSASocket" nocase ascii wide
        $netfunc6 = "HttpSendRequest" ascii wide
        $netfunc7 = "WinHttpSendRequest" ascii wide
        $netfunc8 = "InternetConnect" ascii wide
        $netfunc9 = "InternetOpenUrl" ascii wide
        $netfunc10 = "URLDownloadToFile" ascii wide
        $netfunc11 = "HttpOpenRequest" ascii wide
        $netfunc12 = "WinHttpOpenRequest" ascii wide
        $netfunc13 = "InternetReadFile" ascii wide
        $netfunc14 = "InternetWriteFile" ascii wide
        
        // SSL/TLS hooking and manipulation
        $ssl1 = "PR_Read" ascii wide
        $ssl2 = "PR_Write" ascii wide
        $ssl3 = "SSL_read" ascii wide
        $ssl4 = "SSL_write" ascii wide
        $ssl5 = "SslEncryptPacket" ascii wide
        $ssl6 = "SslDecryptPacket" ascii wide
        $ssl7 = "EncryptMessage" ascii wide
        $ssl8 = "DecryptMessage" ascii wide
        $ssl9 = "PuttySend" ascii wide
        $ssl10 = "PuttyRecv" ascii wide
        
        // C2 communication patterns
        $c2_1 = "POST" nocase ascii wide
        $c2_2 = "GET" nocase ascii wide
        $c2_3 = "HTTP/1." nocase ascii wide
        $c2_4 = "User-Agent:" nocase ascii wide
        $c2_5 = "Content-Type:" nocase ascii wide
        $c2_6 = "Cookie:" nocase ascii wide
        $c2_7 = "Host:" nocase ascii wide
        $c2_8 = "Connection:" nocase ascii wide
        $c2_9 = "Mozilla" nocase ascii wide
        $c2_10 = "Accept" nocase ascii wide
        $c2_11 = "json" nocase ascii wide
        $c2_12 = "base64" nocase ascii wide
        $c2_13 = "Content-Length:" nocase ascii wide
        $c2_14 = "Transfer-Encoding:" nocase ascii wide
        
        // Data exfiltration strings
        $exfil1 = "screenshot" nocase ascii wide
        $exfil2 = "keylog" nocase ascii wide
        $exfil3 = "formgrab" nocase ascii wide
        $exfil4 = "password" nocase ascii wide
        $exfil5 = "credential" nocase ascii wide
        $exfil6 = "cookie" nocase ascii wide
        $exfil7 = "webinject" nocase ascii wide
        $exfil8 = "dump" nocase ascii wide
        $exfil9 = "stolen" nocase ascii wide
        $exfil10 = "grabbed" nocase ascii wide

    condition:
        (
            (2 of ($netcheck*) and 3 of ($netfunc*) and 1 of ($c2_*)) or
            (2 of ($netfunc*) and 2 of ($ssl*) and 2 of ($c2_*)) or
            (2 of ($netfunc*) and 2 of ($c2_*) and 2 of ($exfil*)) or
            (1 of ($ssl*) and 3 of ($c2_*) and 2 of ($exfil*))
        )
}

rule Banking_Trojan_Advanced_Evasion {
    meta:
        description = "Detects advanced evasion techniques used by banking trojans"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // Anti-VM techniques
        $antivm1 = "vmware" nocase ascii wide
        $antivm2 = "virtualbox" nocase ascii wide
        $antivm3 = "vbox" nocase ascii wide
        $antivm4 = "qemu" nocase ascii wide
        $antivm5 = "virtual machine" nocase ascii wide
        $antivm6 = "vmtools" nocase ascii wide
        $antivm7 = "vmmouse" nocase ascii wide
        $antivm8 = "vmscsi" nocase ascii wide
        $antivm9 = "vmhgfs" nocase ascii wide
        $antivm10 = "vboxservice" nocase ascii wide
        $antivm11 = "vboxtray" nocase ascii wide
        $antivm12 = "vmwareuser" nocase ascii wide
        $antivm13 = "parallels" nocase ascii wide
        $antivm14 = "hyperv" nocase ascii wide
        
        // Anti-debug techniques
        $antidebug1 = "IsDebuggerPresent" ascii wide
        $antidebug2 = "CheckRemoteDebuggerPresent" ascii wide
        $antidebug3 = "OutputDebugString" ascii wide
        $antidebug4 = "FindWindow" ascii wide
        $antidebug5 = "GetTickCount" ascii wide
        $antidebug6 = "QueryPerformanceCounter" ascii wide
        $antidebug7 = "GetSystemTime" ascii wide
        $antidebug8 = "ZwQueryInformationProcess" ascii wide
        $antidebug9 = "NtQueryInformationProcess" ascii wide
        $antidebug10 = "DbgBreakPoint" ascii wide
        $antidebug11 = "SwitchToThread" ascii wide
        $antidebug12 = "rdtsc" ascii wide
        $antidebug13 = "INT 2D" ascii wide
        $antidebug14 = "INT 3" ascii wide
        
        // Anti-sandbox techniques
        $antisand1 = "sleep" nocase ascii wide
        $antisand2 = "GetCursorPos" ascii wide
        $antisand3 = "mouse_event" ascii wide
        $antisand4 = "GetAsyncKeyState" ascii wide
        $antisand5 = "GetKeyState" ascii wide
        $antisand6 = "timeGetTime" ascii wide
        $antisand7 = "GetLastInputInfo" ascii wide
        $antisand8 = "WaitForSingleObject" ascii wide
        $antisand9 = "ShellExecute" ascii wide
        $antisand10 = "GetForegroundWindow" ascii wide
        $antisand11 = "GetUserName" ascii wide
        $antisand12 = "GetComputerName" ascii wide
        $antisand13 = "GetProcessHeap" ascii wide
        $antisand14 = "GlobalMemoryStatus" ascii wide
        
        // Process/tool detection
        $proctool1 = "wireshark" nocase ascii wide
        $proctool2 = "processhacker" nocase ascii wide
        $proctool3 = "processexplorer" nocase ascii wide
        $proctool4 = "procmon" nocase ascii wide
        $proctool5 = "regmon" nocase ascii wide
        $proctool6 = "filemon" nocase ascii wide
        $proctool7 = "ollydbg" nocase ascii wide
        $proctool8 = "immunity debugger" nocase ascii wide
        $proctool9 = "x64dbg" nocase ascii wide
        $proctool10 = "windbg" nocase ascii wide
        $proctool11 = "ida" nocase ascii wide
        $proctool12 = "charles" nocase ascii wide
        $proctool13 = "fiddler" nocase ascii wide
        $proctool14 = "tcpview" nocase ascii wide

    condition:
        (
            (3 of ($antivm*)) or
            (3 of ($antidebug*)) or
            (3 of ($antisand*)) or
            (3 of ($proctool*)) or
            (2 of ($antivm*) and 2 of ($antidebug*)) or
            (2 of ($antivm*) and 2 of ($antisand*)) or
            (2 of ($antidebug*) and 2 of ($antisand*)) or
            (1 of ($antivm*) and 1 of ($antidebug*) and 1 of ($antisand*) and 1 of ($proctool*))
        )
} 