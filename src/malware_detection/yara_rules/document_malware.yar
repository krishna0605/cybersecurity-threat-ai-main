/*
 * Document Malware Detection Rules
 * These rules focus on detecting malicious document files (Office, PDF, etc.)
 */

rule Malicious_Office_Macros {
    meta:
        description = "Detects Office documents with potentially malicious macros"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // VBA macro indicators
        $vba1 = "ThisDocument" ascii nocase
        $vba2 = "Auto_Open" ascii nocase
        $vba3 = "AutoOpen" ascii nocase 
        $vba4 = "Document_Open" ascii nocase
        $vba5 = "AutoExec" ascii nocase
        $vba6 = "AutoExit" ascii nocase
        $vba7 = "Workbook_Open" ascii nocase

        // Suspicious macro functionality
        $sus1 = "CreateObject" ascii nocase
        $sus2 = "WScript.Shell" ascii nocase
        $sus3 = "Shell(" ascii nocase
        $sus4 = ".Run" ascii nocase
        $sus5 = "powershell" ascii nocase
        $sus6 = "cmd.exe" ascii nocase
        $sus7 = ".SaveToFile" ascii nocase
        $sus8 = "ADODB.Stream" ascii nocase
        $sus9 = "chr(" ascii nocase
        $sus10 = "ProcessStartInfo" ascii nocase
        $sus11 = "Hidden" ascii nocase
        $sus12 = "GetObject" ascii nocase
        $sus13 = "Microsoft.XMLHTTP" ascii nocase
        
        // Obfuscation techniques
        $obs1 = "Chr(Asc(" ascii nocase
        $obs2 = "Mid(" ascii nocase
        $obs3 = "Join(" ascii nocase
        $obs4 = "StrReverse" ascii nocase
        $obs5 = "Replace(" ascii nocase
        $obs6 = "Xor" ascii nocase

    condition:
        (uint32(0) == 0xE011CFD0 or // Word Document
         uint32(0) == 0xE11AB1A1 or // Excel Document
         uint16(0) == 0xD0CF) and   // OLE file
        (
            (1 of ($vba*) and 2 of ($sus*)) or
            (1 of ($vba*) and 2 of ($obs*)) or
            (3 of ($sus*) and 1 of ($obs*))
        )
}

rule Malicious_PDF {
    meta:
        description = "Detects PDF files with potentially malicious content"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // PDF header
        $pdf_header = "%PDF-"
        
        // JavaScript indicators
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $js3 = "getAnnots" nocase
        $js4 = "getAnnot" nocase
        
        // Suspicious content
        $sus1 = "/AA" nocase
        $sus2 = "/OpenAction" nocase
        $sus3 = "/AcroForm" nocase
        $sus4 = "/Launch" nocase
        $sus5 = "/SubmitForm" nocase
        $sus6 = "/URI" nocase
        $sus7 = "/RichMedia" nocase
        
        // Exploits and shellcode
        $exp1 = "this.collabStore" nocase
        $exp2 = "util.printf" nocase
        $exp3 = "getIcon" nocase
        $exp4 = "spell.customDictionaryOpen" nocase
        $exp5 = "media.newPlayer" nocase
        $exp6 = "app.setInterval" nocase
        
        // Obfuscation
        $obs1 = "/FlateDecode" nocase
        $obs2 = "/ASCIIHexDecode" nocase
        $obs3 = "/ASCII85Decode" nocase
        $obs4 = "eval(" nocase
        $obs5 = "unescape(" nocase

    condition:
        $pdf_header at 0 and
        (
            (1 of ($js*) and 2 of ($sus*)) or
            (1 of ($exp*)) or
            (2 of ($js*) and 2 of ($obs*) and 1 of ($sus*))
        )
}

rule Suspicious_HTA_File {
    meta:
        description = "Detects suspicious HTML Application (HTA) files"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        $hta1 = "<hta:application" nocase
        $hta2 = "<HTA:APPLICATION" nocase
        $hta3 = "hta:application" nocase
        
        $sus1 = "document.write" nocase
        $sus2 = "ActiveXObject" nocase
        $sus3 = "WScript.Shell" nocase
        $sus4 = "Shell.Application" nocase
        $sus5 = "cmd.exe" nocase
        $sus6 = "powershell" nocase
        $sus7 = "mshtml" nocase
        $sus8 = "msxml2" nocase
        
        $obs1 = "FromBase64String" nocase
        $obs2 = "eval(" nocase
        $obs3 = "unescape(" nocase
        $obs4 = "escape(" nocase
        $obs5 = "String.fromCharCode" nocase
        $obs6 = "window.atob" nocase

    condition:
        1 of ($hta*) and
        (
            (2 of ($sus*)) or
            (1 of ($sus*) and 1 of ($obs*))
        )
}

rule Suspicious_RTF_File {
    meta:
        description = "Detects potentially malicious RTF files"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        $rtf_header = "{\\rtf1"
        
        // Object indicators
        $obj1 = "\\object" nocase
        $obj2 = "\\objdata" nocase
        $obj3 = "\\objupdate" nocase
        $obj4 = "\\objclass" nocase
        $obj5 = "\\objemb" nocase
        
        // Exploit indicators
        $exp1 = "equation.3" nocase
        $exp2 = "objhtml" nocase
        $exp3 = "\\objlink" nocase
        $exp4 = "\\listoverride" nocase
        $exp5 = "pFragments" nocase
        
        // Obfuscation
        $obs1 = "{\\*\\generator" nocase
        $obs2 = "\\bin" nocase
        $obs3 = "\\bliptag" nocase
        $obs4 = "\\*\\" nocase
        $obs5 = "\\'F" nocase
        $obs6 = "\\headerf" nocase
        
        // Hex encoded
        $hex1 = /\\\'[0-9a-fA-F]{2}\\\'[0-9a-fA-F]{2}\\\'[0-9a-fA-F]{2}\\\'[0-9a-fA-F]{2}/

    condition:
        $rtf_header at 0 and
        (
            (1 of ($obj*) and 1 of ($exp*)) or
            (2 of ($obj*) and 1 of ($obs*)) or
            ($hex1 and 1 of ($obj*)) or
            (2 of ($exp*))
        )
} 