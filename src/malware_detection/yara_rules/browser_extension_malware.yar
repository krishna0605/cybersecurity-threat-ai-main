/*
 * Browser Extension Malware Detection Rules
 * These rules focus on detecting malicious browser extensions
 */

rule Suspicious_Extension_Permissions {
    meta:
        description = "Detects browser extensions with suspicious permission combinations"
        author = "Security Team"
        severity = "medium"
        date = "2023-10-15"
    
    strings:
        // Manifest file identifiers
        $manifest = "manifest.json" nocase
        
        // Suspicious permission combinations
        $perm_all_urls = "\"*://*/*\"" nocase
        $perm_all_http = "\"http://*/*\"" nocase
        $perm_all_https = "\"https://*/*\"" nocase
        
        // High-risk permissions
        $high_perm1 = "\"tabs\"" nocase
        $high_perm2 = "\"webRequest\"" nocase
        $high_perm3 = "\"webRequestBlocking\"" nocase
        $high_perm4 = "\"proxy\"" nocase
        $high_perm5 = "\"cookies\"" nocase
        $high_perm6 = "\"history\"" nocase
        $high_perm7 = "\"<all_urls>\"" nocase
        $high_perm8 = "\"bookmarks\"" nocase
        $high_perm9 = "\"management\"" nocase
        $high_perm10 = "\"storage\"" nocase
        $high_perm11 = "\"clipboardRead\"" nocase
        $high_perm12 = "\"clipboardWrite\"" nocase
        
        // Suspicious background operations
        $bg1 = "\"background\"" nocase
        $bg2 = "\"persistent\": true" nocase
        
        // Content script behavior
        $cs1 = "\"content_scripts\"" nocase
        $cs2 = "\"run_at\": \"document_start\"" nocase
        $cs3 = "\"all_frames\": true" nocase

    condition:
        $manifest and
        (
            (
                (1 of ($perm_all_urls, $perm_all_http, $perm_all_https, $high_perm7)) and
                (3 of ($high_perm*))
            ) or
            (
                $bg1 and $bg2 and (2 of ($high_perm*)) and 
                (1 of ($perm_all_urls, $perm_all_http, $perm_all_https, $high_perm7))
            ) or
            (
                $cs1 and $cs2 and $cs3 and
                (2 of ($high_perm*)) and
                (1 of ($perm_all_urls, $perm_all_http, $perm_all_https, $high_perm7))
            )
        )
}

rule Suspicious_Extension_Functionality {
    meta:
        description = "Detects browser extensions with suspicious code functionality"
        author = "Security Team"
        severity = "medium"
        date = "2023-10-15"
    
    strings:
        // JavaScript API injections
        $js_api1 = "chrome.webRequest" nocase
        $js_api2 = "chrome.tabs" nocase
        $js_api3 = "chrome.cookies" nocase
        $js_api4 = "browser.webRequest" nocase
        $js_api5 = "browser.tabs" nocase
        $js_api6 = "browser.cookies" nocase
        
        // Form interaction
        $form1 = "document.forms" nocase
        $form2 = "getElementsByTagName(\"form\")" nocase
        $form3 = "querySelector(\"form\")" nocase
        $form4 = "querySelectorAll(\"form\")" nocase
        $form5 = "addEventListener(\"submit\"" nocase
        
        // Password field access
        $pwd1 = "type=\\\"password\\\"" nocase
        $pwd2 = "type='password'" nocase
        $pwd3 = "type=\"password\"" nocase
        $pwd4 = "input[type='password']" nocase
        $pwd5 = "input[type=\"password\"]" nocase
        
        // Cookie manipulation
        $cookie1 = "document.cookie" nocase
        $cookie2 = ".cookie" nocase
        
        // Traffic manipulation
        $traffic1 = "onBeforeRequest" nocase
        $traffic2 = "onBeforeSendHeaders" nocase
        $traffic3 = "onHeadersReceived" nocase
        
        // Storage access
        $storage1 = "localStorage" nocase
        $storage2 = "sessionStorage" nocase

    condition:
        (
            (1 of ($js_api*) and 1 of ($form*) and 1 of ($pwd*)) or
            (1 of ($js_api*) and 1 of ($cookie*) and 1 of ($traffic*)) or
            (2 of ($js_api*) and 2 of ($pwd*)) or
            (2 of ($js_api*) and 2 of ($traffic*)) or
            (1 of ($traffic*) and 2 of ($form*) and 1 of ($storage*))
        )
}

rule Malicious_Extension_Communication {
    meta:
        description = "Detects browser extensions with suspicious communication patterns"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // External communication
        $comm1 = "new XMLHttpRequest()" nocase
        $comm2 = "fetch(" nocase
        $comm3 = "$.ajax" nocase
        $comm4 = "$.get" nocase
        $comm5 = "$.post" nocase
        $comm6 = "WebSocket(" nocase
        
        // Command and control patterns
        $cnc1 = "POST" nocase fullword
        $cnc2 = "GET" nocase fullword
        $cnc3 = "setInterval" nocase
        $cnc4 = "setTimeout" nocase
        
        // Data exfiltration
        $exfil1 = ".value" nocase
        $exfil2 = ".innerText" nocase
        $exfil3 = ".textContent" nocase
        $exfil4 = "JSON.stringify" nocase
        $exfil5 = "encodeURIComponent" nocase
        $exfil6 = "btoa(" nocase
        
        // URL patterns
        $url1 = /https?:\/\/[^\/]+\.ru\// nocase
        $url2 = /https?:\/\/[^\/]+\.cn\// nocase
        $url3 = /https?:\/\/[^\/]+\.xyz\// nocase
        $url4 = /https?:\/\/[^\/]+\.tk\// nocase
        $url5 = /https?:\/\/[^\/]+\.cc\// nocase
        $url6 = /https?:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/ nocase
        
        // Encoded data transfer
        $enc1 = "base64" nocase
        $enc2 = "encodeURI" nocase
        $enc3 = "escape(" nocase

    condition:
        (
            (1 of ($comm*) and 1 of ($exfil*) and 1 of ($cnc*)) or
            (1 of ($comm*) and 1 of ($url*)) or
            (1 of ($comm*) and 1 of ($exfil*) and 1 of ($enc*)) or
            (2 of ($comm*) and 2 of ($cnc*)) or
            (1 of ($url*) and 1 of ($exfil*))
        )
}

rule Extension_Code_Injection {
    meta:
        description = "Detects browser extensions that may perform code injection"
        author = "Security Team"
        severity = "high"
        date = "2023-10-15"
    
    strings:
        // DOM manipulation for script injection
        $dom1 = "createElement(\"script\")" nocase
        $dom2 = "createElement('script')" nocase
        $dom3 = "document.write(" nocase
        $dom4 = "innerHTML =" nocase
        $dom5 = ".innerHTML =" nocase
        $dom6 = ".appendChild(" nocase
        
        // Eval and similar functions
        $eval1 = "eval(" nocase
        $eval2 = "Function(" nocase
        $eval3 = "new Function(" nocase
        
        // Script source manipulation
        $src1 = ".src =" nocase
        $src2 = "setAttribute(\"src\"" nocase
        $src3 = "setAttribute('src'" nocase
        
        // Content manipulation
        $content1 = "document.body" nocase
        $content2 = "document.head" nocase
        $content3 = "document.documentElement" nocase
        
        // Injection mechanisms
        $inject1 = "insertBefore" nocase
        $inject2 = "insertAfter" nocase
        $inject3 = "replaceChild" nocase
        $inject4 = "iframe" nocase
        $inject5 = "postMessage" nocase

    condition:
        (
            (1 of ($dom*) and 1 of ($eval*)) or
            (1 of ($dom*) and 1 of ($src*) and 1 of ($content*)) or
            (1 of ($dom*) and 1 of ($inject*) and 1 of ($content*)) or
            (2 of ($eval*)) or
            (2 of ($dom*) and 1 of ($inject*))
        )
} 